---
title: "Simple plotting options for radiocarbon dates in c14_date_lists"
author: "Clemens Schmid"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Simple plotting options for radiocarbon dates in c14_date_lists}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

This vignette shows some basic workflows to plot radiocarbon dates in `c14_date_list`s. This is only a short compilation to get you started with c14bazAAR output and [ggplot2](https://ggplot2.tidyverse.org/). 

So let's get started by loading the main packages for this endeavour: c14bazAAR and ggplot2. We will use functions from other packages as well, but address them individually with the `::` operator.

```{r}
library(c14bazAAR)
library(ggplot2)
```

The basis for this example code is the [aDRAC data collection](https://github.com/dirkseidensticker/aDRAC) by Dirk Seidensticker. So let's download the data with the relevant c14bazAAR getter function: 

```{r}
aDRAC <- get_aDRAC()
```

## Plotting radiocarbon ages

Radiocarbon dating is a method to determine the abolute age of samples. Therefore one of the main aims for plotting naturally is to display temporal information. Let's select the dates of one individual site -- *Batalimo* in Central Africa -- as a subset to reproduce two of the most common types of radiocarbon date plots.

```{r}
Batalimo <- aDRAC %>%
  dplyr::filter(site == "Batalimo")
```

If age modelling and date plotting on a local or regional scale is the major aim of your analysis, you might want to take a look at the [oxcAAR](https://CRAN.R-project.org/package=oxcAAR ) package. It serves as an R interface to the [OxCal](https://c14.arch.ox.ac.uk/oxcal.html) software and provides powerful default plotting options.

### Ridgeplots of density distributions

One way to plot radiocarbon dates is to show the probability density distribution of individual calibrated dates as ridgeplots. To produce a plot like that, we need the age-probability information for each plot. We can calculate that with the function `c14bazAAR::calibrate()`. 

```{r, include = FALSE}
Batalimo_calibrated <- Batalimo %>%
  calibrate(choices = "calprobdistr")
```

```{r, eval = FALSE}
Batalimo_calibrated <- Batalimo %>%
  calibrate(choices = "calprobdistr")
```

This adds a list column `calprobdistr` to the input `c14_date_list`. The list column contains a nested data.frame for each date with its probability distribution. 

```{r, echo=FALSE}
Batalimo_calibrated
```

With `tidyr::unnest()` the list column can be dissolved and integrated into the initial `c14_date_list`. Of course the latter looses its original structure and meaning with this step. Each row now represents the probability for one date and year.

```{r}
Batalimo_cal_dens <- Batalimo_calibrated %>% tidyr::unnest()
```

A table like that can be used for plotting a ridgeplot. 

```{r}
Batalimo_cal_dens %>%
  ggplot() +
  # a special geom for ridgeplots is provided by the ggridges package
  ggridges::geom_ridgeline(
    # the relevant variables that have to be mapped for this geom are 
    # x (the time -- here the calibrated age transformed to calBC), 
    # y (the individual lab number of the dates) and
    # height (the probability for each year and date) 
    aes(x = -calage + 1950, y = labnr, height = density),
    # ridgeplots lack a scientifically clear y axis for each 
    # distribution plot and we can adjust the scaling to our needs
    scale = 300
  ) +
  xlab("age calBC/calAD") +
  ylab("dates")
```

### Calcurve plot

Another way to plot radiocarbon dates is to project them onto a calibration curve. The [Bchron](https://CRAN.R-project.org/package=Bchron) R package contains a data.frame with the [intcal13](https://www.doi.org/10.2458/azu_js_rc.55.16947) calibration curve data. We can load the `intcal13` table directly from Bchron.

```{r}
load(system.file('data/intcal13.rda', package = 'Bchron'))
```

For this kind of plot it is more convinient to work with the simplified `calrange` output of `c14bazAAR::calibrate()`.

```{r, include = FALSE}
Batalimo_calibrated <- Batalimo %>%
  calibrate(choices = "calrange")
```

```{r, eval = FALSE}
Batalimo_calibrated <- Batalimo %>%
  calibrate(choices = "calrange")
```

Like the `calprobdistr` option this also adds a list column to the input `c14_date_list`, but a much shorter one for each date only with the age ranges that make up the 2-sigma significance interval of the probability distribution.

```{r}
Batalimo_calibrated$calrange[1:3]
```

Thre resulting table can also be unnested to make the list column content available in the main table.

```{r}
Batalimo_cal_range <- Batalimo_calibrated %>% tidyr::unnest()
```

Now we can plot the calibration curve and -- on top -- error bars with the `calrange` sequences.

```{r, warning=FALSE}
ggplot() +
  geom_line(
    data = intcal13,
    mapping = aes(x = -V1 + 1950, y = -V2 + 1950)
  ) +
  geom_errorbarh(
    data = Batalimo_cal_range,
    mapping = aes(y = -c14age + 1950, xmin = -to + 1950, xmax = -from + 1950)
  ) +
  xlim(-1000, 2000) +
  ylim(2000, -1000) +
  xlab("age calBC/calAD") +
  ylab("uncalibrated age BC/AD")
```

## Map

```{r}
Moga_spatial <- aDRAC %>%
  as.sf %>%
  dplyr::filter(grepl("Moga 2008", data.shortref)) %>%
  dplyr::group_by(data.site) %>%
  dplyr::summarise()
```

### interactive

```{r}
Moga_spatial %>% mapview::mapview()
```

### static

```{r}
countries <- rnaturalearth::ne_countries() %>% sf::st_as_sf()
```

```{r}
ggplot() +
  geom_sf(data = countries) +
  geom_sf(data = Moga_spatial) +
  geom_sf_text(data = countries, mapping = aes(label = formal_en)) +
  coord_sf(xlim = c(10, 30), ylim = c(0, 15))
```
